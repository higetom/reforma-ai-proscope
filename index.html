<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Re'Forma AI ProScope</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }
        
        .header {
            margin: 20px 0;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
            transition: all 0.3s ease;
            word-wrap: break-word;
        }
        
        .status.loading {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }
        
        .video-container {
            position: relative;
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            background: #000;
        }
        
        #video {
            width: 100%;
            height: 400px;
            object-fit: cover;
            background: #000;
            border-radius: 15px;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .controls {
            margin: 20px 0;
        }
        
        .btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            min-width: 150px;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn.primary {
            background: rgba(0,123,255,0.8);
            border-color: rgba(0,123,255,1);
        }
        
        .btn.primary:hover, .btn.primary:active {
            background: rgba(0,123,255,1);
        }
        
        .results {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            text-align: left;
        }
        
        .results h3 {
            margin-bottom: 15px;
            color: #fff;
            text-align: center;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-left {
            flex: 1;
        }
        
        .result-right {
            text-align: right;
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        .instructions {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .instructions h3 {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 8px 0;
            line-height: 1.4;
        }
        
        .debug-info {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 12px;
            text-align: left;
            font-family: monospace;
        }
        
        .footer {
            margin-top: 30px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .logo {
                font-size: 24px;
            }
            
            #video {
                height: 350px;
            }
            
            .btn {
                min-width: 120px;
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">🎯 Re'Forma AI</div>
            <div class="subtitle">姿勢分析システム</div>
        </div>
        
        <div class="instructions">
            <h3>📱 iPhone使用方法</h3>
            <ol>
                <li><strong>カメラ許可</strong>: 必ずカメラアクセスを許可</li>
                <li><strong>縦向き</strong>: スマホを縦に持って使用</li>
                <li><strong>距離</strong>: 2m程度離れて全身を映す</li>
                <li><strong>明るさ</strong>: 十分な明かりがある場所で</li>
                <li><strong>Wi-Fi</strong>: 安定したネット接続で使用</li>
            </ol>
        </div>

        <div id="status" class="status loading">
            📡 システム初期化中...
        </div>

        <div class="controls">
            <button id="startBtn" class="btn primary" onclick="startCamera()">
                📷 カメラ開始
            </button>
            <button id="stopBtn" class="btn" onclick="stopCamera()" style="display:none;">
                ⏹️ 停止
            </button>
            <button id="debugBtn" class="btn" onclick="toggleDebug()" style="display:none;">
                🔧 デバッグ
            </button>
        </div>

        <div class="video-container">
            <video id="video" autoplay muted playsinline webkit-playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <div id="results" class="results" style="display:none;">
            <h3>📊 姿勢分析結果</h3>
            <div id="resultContent"></div>
        </div>

        <div id="debugInfo" class="debug-info" style="display:none;">
            <h4>🔧 デバッグ情報</h4>
            <div id="debugContent"></div>
        </div>
        
        <div class="footer">
            <p>Re'Forma AI ProScope</p>
            <p>運動連鎖理論による姿勢分析</p>
            <small>※理学療法士の専門評価を補助するツールです</small>
        </div>
    </div>

    <script>
        let camera;
        let pose;
        let video;
        let canvas;
        let ctx;
        let isAnalyzing = false;
        let debugMode = false;
        let detectionCount = 0;
        let lastDetectionTime = 0;

        // MediaPipe CDN URLs (HTTPSで確実に動作するように)
        const MEDIAPIPE_CDN = 'https://cdn.jsdelivr.net/npm/@mediapipe/';
        
        // ユーザーエージェント検出
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        // デバッグ情報更新
        function updateDebugInfo() {
            if (!debugMode) return;
            
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = `
                <strong>デバイス情報:</strong><br>
                iOS: ${isIOS}<br>
                Safari: ${isSafari}<br>
                UserAgent: ${navigator.userAgent.substring(0, 50)}...<br>
                <br>
                <strong>接続情報:</strong><br>
                Protocol: ${location.protocol}<br>
                Host: ${location.host}<br>
                MediaDevices: ${!!navigator.mediaDevices}<br>
                <br>
                <strong>分析状況:</strong><br>
                検出回数: ${detectionCount}<br>
                最終検出: ${lastDetectionTime ? new Date(lastDetectionTime).toLocaleTimeString() : '未検出'}<br>
                MediaPipe: ${typeof Pose !== 'undefined' ? '読み込み完了' : '読み込み中'}<br>
            `;
        }

        // デバッグモード切り替え
        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugInfo').style.display = debugMode ? 'block' : 'none';
            document.getElementById('debugBtn').textContent = debugMode ? '🔧 デバッグ終了' : '🔧 デバッグ';
            if (debugMode) {
                updateDebugInfo();
                setInterval(updateDebugInfo, 1000);
            }
        }

        // 初期化（段階的に実行）
        async function init() {
            try {
                updateStatus("loading", "📱 デバイス確認中...");
                
                // デバイス情報確認
                if (isIOS) {
                    updateStatus("loading", "📱 iPhone検出 - Safari最適化モード");
                }
                
                // MediaDevices API確認
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('カメラAPIが利用できません。HTTPSが必要です。');
                }
                
                updateStatus("loading", "📡 MediaPipe読み込み中...");
                
                // MediaPipe初期化（遅延読み込み）
                await initMediaPipe();
                
                updateStatus("success", "✅ システム準備完了！");
                document.getElementById('debugBtn').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Init error:', error);
                updateStatus("error", `❌ 初期化エラー: ${error.message}`);
                
                // フォールバック: 基本カメラ機能のみ
                if (navigator.mediaDevices) {
                    updateStatus("loading", "⚠️ 基本カメラモードで動作します");
                }
            }
        }

        // MediaPipe初期化
        async function initMediaPipe() {
            return new Promise((resolve, reject) => {
                try {
                    // 動的スクリプト読み込み
                    if (typeof Pose === 'undefined') {
                        loadMediaPipeScripts().then(() => {
                            setupPose();
                            resolve();
                        }).catch(reject);
                    } else {
                        setupPose();
                        resolve();
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        // MediaPipeスクリプト読み込み
        function loadMediaPipeScripts() {
            return new Promise((resolve, reject) => {
                const scripts = [
                    'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js',
                    'https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js'
                ];
                
                let loadedCount = 0;
                
                scripts.forEach(src => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        loadedCount++;
                        if (loadedCount === scripts.length) {
                            setTimeout(resolve, 1000); // 1秒待機
                        }
                    };
                    script.onerror = () => reject(new Error(`Script load failed: ${src}`));
                    document.head.appendChild(script);
                });
            });
        }

        // Pose設定
        function setupPose() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            try {
                pose = new Pose({
                    locateFile: (file) => {
                        return `${MEDIAPIPE_CDN}pose/${file}`;
                    }
                });

                // iOS/Safari向け最適化設定
                pose.setOptions({
                    modelComplexity: isIOS ? 0 : 1, // iOSでは軽量モード
                    smoothLandmarks: true,
                    enableSegmentation: false,
                    smoothSegmentation: false,
                    minDetectionConfidence: isIOS ? 0.5 : 0.6,
                    minTrackingConfidence: isIOS ? 0.4 : 0.5
                });

                pose.onResults(onResults);
                
            } catch (error) {
                throw new Error(`MediaPipe設定エラー: ${error.message}`);
            }
        }

        // カメラ開始（iPhone対応強化）
        async function startCamera() {
            try {
                updateStatus("loading", "📷 カメラ起動中...");
                
                // iPhone向け制約
                const constraints = {
                    video: {
                        facingMode: 'user',
                        width: { ideal: isIOS ? 360 : 480 },
                        height: { ideal: isIOS ? 640 : 640 },
                        frameRate: { ideal: isIOS ? 15 : 30 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // iOS Safariでの再生問題対応
                video.setAttribute('playsinline', 'true');
                video.setAttribute('webkit-playsinline', 'true');
                video.muted = true;
                
                // メタデータ読み込み完了を待機
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        // キャンバスサイズ設定
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve();
                    };
                });
                
                // 再生開始
                await video.play();
                
                // UI更新
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
                
                // 分析開始（遅延）
                setTimeout(() => {
                    startAnalysis();
                }, 1000);
                
            } catch (error) {
                console.error('Camera error:', error);
                let errorMessage = "❌ カメラエラー: ";
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += "カメラの許可が必要です";
                } else if (error.name === 'NotFoundError') {
                    errorMessage += "カメラが見つかりません";
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += "HTTPSが必要です";
                } else {
                    errorMessage += error.message;
                }
                
                updateStatus("error", errorMessage);
            }
        }

        // 分析開始
        function startAnalysis() {
            if (!isAnalyzing && pose && video.readyState >= 2) {
                isAnalyzing = true;
                updateStatus("success", "🎥 姿勢分析開始中...");
                sendFrame();
            }
        }

        // フレーム送信（エラーハンドリング強化）
        async function sendFrame() {
            if (!isAnalyzing || video.readyState < 2) return;
            
            try {
                if (pose && typeof pose.send === 'function') {
                    await pose.send({image: video});
                }
            } catch (error) {
                console.error('Frame analysis error:', error);
                // エラーが発生しても継続
            }
            
            if (isAnalyzing) {
                requestAnimationFrame(sendFrame);
            }
        }

        // カメラ停止
        function stopCamera() {
            isAnalyzing = false;
            
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            
            // キャンバスクリア
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            updateStatus("loading", "⏹️ 停止しました");
        }

        // 姿勢検出結果処理（強化版）
        function onResults(results) {
            if (!ctx || !canvas) return;
            
            try {
                // キャンバスをクリア
                ctx.save();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 姿勢が検出された場合
                if (results.poseLandmarks && results.poseLandmarks.length > 0) {
                    detectionCount++;
                    lastDetectionTime = Date.now();
                    
                    updateStatus("success", "🎯 姿勢検出成功！");
                    
                    // 描画（エラーハンドリング付き）
                    try {
                        drawLandmarks(ctx, results.poseLandmarks);
                        drawConnections(ctx, results.poseLandmarks);
                        analyzePosture(results.poseLandmarks);
                        document.getElementById('results').style.display = 'block';
                    } catch (drawError) {
                        console.error('Drawing error:', drawError);
                    }
                    
                } else {
                    updateStatus("loading", "👤 体全体を画面に映してください");
                    document.getElementById('results').style.display = 'none';
                }
                
                ctx.restore();
                
            } catch (error) {
                console.error('Results processing error:', error);
            }
        }

        // ランドマーク描画（エラーハンドリング付き）
        function drawLandmarks(ctx, landmarks) {
            try {
                ctx.fillStyle = '#00FF00';
                ctx.strokeStyle = '#00FF00';
                ctx.lineWidth = 2;
                
                for (const landmark of landmarks) {
                    if (landmark && landmark.visibility > 0.5) {
                        ctx.beginPath();
                        ctx.arc(
                            landmark.x * canvas.width, 
                            landmark.y * canvas.height, 
                            4, 0, 2 * Math.PI
                        );
                        ctx.fill();
                    }
                }
            } catch (error) {
                console.error('Landmark drawing error:', error);
            }
        }

        // 接続線描画（エラーハンドリング付き）
        function drawConnections(ctx, landmarks) {
            try {
                ctx.strokeStyle = '#00FF00';
                ctx.lineWidth = 2;
                
                const connections = [
                    [11, 12], [11, 13], [13, 15], [12, 14], [14, 16],
                    [11, 23], [12, 24], [23, 24],
                    [23, 25], [24, 26], [25, 27], [26, 28]
                ];
                
                for (const [start, end] of connections) {
                    const startPoint = landmarks[start];
                    const endPoint = landmarks[end];
                    
                    if (startPoint && endPoint && 
                        startPoint.visibility > 0.5 && endPoint.visibility > 0.5) {
                        ctx.beginPath();
                        ctx.moveTo(
                            startPoint.x * canvas.width, 
                            startPoint.y * canvas.height
                        );
                        ctx.lineTo(
                            endPoint.x * canvas.width, 
                            endPoint.y * canvas.height
                        );
                        ctx.stroke();
                    }
                }
            } catch (error) {
                console.error('Connection drawing error:', error);
            }
        }

        // 姿勢分析（Re'Forma運動連鎖理論適用）
        function analyzePosture(landmarks) {
            try {
                const resultContent = document.getElementById('resultContent');
                
                // 主要ポイントの取得
                const leftShoulder = landmarks[11];
                const rightShoulder = landmarks[12];
                const leftHip = landmarks[23];
                const rightHip = landmarks[24];
                const nose = landmarks[0];
                
                let analysis = [];
                
                // 肩のライン評価
                if (isValidLandmark(leftShoulder) && isValidLandmark(rightShoulder)) {
                    const shoulderAnalysis = analyzeShoulder(leftShoulder, rightShoulder);
                    analysis.push(shoulderAnalysis);
                }
                
                // 骨盤のライン評価
                if (isValidLandmark(leftHip) && isValidLandmark(rightHip)) {
                    const hipAnalysis = analyzeHip(leftHip, rightHip);
                    analysis.push(hipAnalysis);
                }
                
                // 頭部位置評価
                if (isValidLandmark(nose) && isValidLandmark(leftShoulder) && isValidLandmark(rightShoulder)) {
                    const headAnalysis = analyzeHead(nose, leftShoulder, rightShoulder);
                    analysis.push(headAnalysis);
                }
                
                // 運動連鎖分析
                const kineticChainAnalysis = analyzeKineticChain(analysis);
                
                // 結果表示
                displayResults(resultContent, analysis, kineticChainAnalysis);
                
            } catch (error) {
                console.error('Posture analysis error:', error);
                document.getElementById('resultContent').innerHTML = `
                    <div style="color: #FF9800; text-align: center;">
                        ⚠️ 分析中にエラーが発生しました<br>
                        <small>もう一度お試しください</small>
                    </div>
                `;
            }
        }

        // ランドマーク有効性チェック
        function isValidLandmark(landmark) {
            return landmark && landmark.visibility > 0.5;
        }

        // 肩分析
        function analyzeShoulder(leftShoulder, rightShoulder) {
            const diff = Math.abs(leftShoulder.y - rightShoulder.y);
            const angle = Math.atan2(
                rightShoulder.y - leftShoulder.y,
                rightShoulder.x - leftShoulder.x
            ) * 180 / Math.PI;
            
            const severity = diff > 0.05 ? "要注意" : diff > 0.03 ? "軽度傾斜" : "良好";
            const color = severity === "良好" ? "#4CAF50" : severity === "軽度傾斜" ? "#FF9800" : "#F44336";
            
            return {
                area: "肩のライン",
                status: severity,
                color: color,
                value: `${Math.abs(angle).toFixed(1)}°`,
                implication: diff > 0.04 ? "頸部痛・肩こりの可能性" : "バランス良好"
            };
        }

        // 骨盤分析
        function analyzeHip(leftHip, rightHip) {
            const diff = Math.abs(leftHip.y - rightHip.y);
            const angle = Math.atan2(
                rightHip.y - leftHip.y,
                rightHip.x - leftHip.x
            ) * 180 / Math.PI;
            
            const severity = diff > 0.05 ? "要注意" : diff > 0.03 ? "軽度傾斜" : "良好";
            const color = severity === "良好" ? "#4CAF50" : severity === "軽度傾斜" ? "#FF9800" : "#F44336";
            
            return {
                area: "骨盤のライン",
                status: severity,
                color: color,
                value: `${Math.abs(angle).toFixed(1)}°`,
                implication: diff > 0.04 ? "腰痛・膝痛の可能性" : "バランス良好"
            };
        }

        // 頭部分析
        function analyzeHead(nose, leftShoulder, rightShoulder) {
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            
            const offset = Math.abs(nose.x - shoulderCenter.x);
            const severity = offset > 0.08 ? "要注意" : offset > 0.05 ? "軽度前傾" : "良好";
            const color = severity === "良好" ? "#4CAF50" : severity === "軽度前傾" ? "#FF9800" : "#F44336";
            
            return {
                area: "頭部位置",
                status: severity,
                color: color,
                value: `${(offset * 100).toFixed(1)}%`,
                implication: offset > 0.07 ? "ストレートネック傾向" : "正常範囲"
            };
        }

        // 運動連鎖分析（Re'Forma理論）
        function analyzeKineticChain(analysis) {
            const issues = analysis.filter(item => item.status !== "良好");
            
            if (issues.length === 0) {
                return {
                    overall: "良好",
                    message: "全体的なバランスが良好です",
                    recommendations: ["現在の良好な状態を維持しましょう"]
                };
            }
            
            let recommendations = [];
            let primaryConcern = "";
            
            // 運動連鎖パターン分析
            const hasPelvicIssue = issues.some(item => item.area === "骨盤のライン");
            const hasShoulderIssue = issues.some(item => item.area === "肩のライン");
            const hasHeadIssue = issues.some(item => item.area === "頭部位置");
            
            if (hasPelvicIssue) {
                primaryConcern = "骨盤の傾きが他部位に影響している可能性";
                recommendations.push("股関節の柔軟性向上");
                recommendations.push("体幹筋力強化");
            }
            
            if (hasShoulderIssue && hasHeadIssue) {
                primaryConcern = "上位交差症候群の傾向";
                recommendations.push("胸椎可動性向上");
                recommendations.push("深層頸屈筋強化");
            }
            
            return {
                overall: issues.length > 2 ? "要注意" : "軽度改善推奨",
                message: primaryConcern || "姿勢バランスの改善をお勧めします",
                recommendations: recommendations.length > 0 ? recommendations : ["専門的な評価をお勧めします"]
            };
        }

        // 結果表示
        function displayResults(container, analysis, kineticChain) {
            const resultHTML = `
                ${analysis.map(item => `
                    <div class="result-item">
                        <div class="result-left">
                            <strong>${item.area}</strong><br>
                            <small style="opacity: 0.8;">${item.implication}</small>
                        </div>
                        <div class="result-right">
                            <div style="color: ${item.color}; font-weight: bold;">
                                ${item.status}
                            </div>
                            <small>${item.value}</small>
                        </div>
                    </div>
                `).join('')}
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <h4 style="margin-bottom: 10px; color: #fff;">🔗 運動連鎖分析</h4>
                    <div style="color: ${kineticChain.overall === '良好' ? '#4CAF50' : '#FF9800'}; font-weight: bold; margin-bottom: 8px;">
                        総合評価: ${kineticChain.overall}
                    </div>
                    <div style="margin-bottom: 10px; font-size: 14px;">
                        ${kineticChain.message}
                    </div>
                    <div style="font-size: 12px; opacity: 0.9;">
                        <strong>推奨アプローチ:</strong><br>
                        ${kineticChain.recommendations.map(rec => `• ${rec}`).join('<br>')}
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 11px; text-align: center;">
                    <strong>📋 Re'Forma AI ProScope</strong><br>
                    運動連鎖理論に基づく姿勢評価システム<br>
                    <em style="color: #FFD700;">※詳細な評価・治療は理学療法士にご相談ください</em>
                </div>
            `;
            
            container.innerHTML = resultHTML;
        }

        // ステータス更新
        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        // ページ読み込み完了時に初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus("loading", "🚀 Re'Forma AI 起動中...");
            
            // 段階的初期化
            setTimeout(() => {
                init();
            }, 500);
        });

        // エラーハンドリング強化
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            updateStatus("error", "❌ システムエラー: ページを再読み込みしてください");
        });

        // iOS Safari特有の問題対応
        window.addEventListener('pagehide', function() {
            if (isAnalyzing) {
                stopCamera();
            }
        });

        // タッチイベント最適化
        document.addEventListener('touchstart', function() {}, {passive: true});
        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName !== 'VIDEO') {
                e.preventDefault();
            }
        }, {passive: false});

        // オリエンテーション変更対応
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                if (canvas && video) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                }
            }, 500);
        });
    </script>
</body>
</html>
